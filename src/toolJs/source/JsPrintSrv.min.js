!function(e,t,a,i){e.fn.getCursorPosition=function(){var i=e(this).get(0),n=0
if("selectionStart"in i)n=i.selectionStart
else if("selection"in a){i.focus()
var r=a.selection.createRange(),s=a.selection.createRange().text.length
r.moveStart("character",-i.value.length),n=r.text.length-s}else{if(a.all)i.range=a.selection.createRange(),i.range.select(),i.range.moveStart("character",-1)
else i.range=t.getSelection().getRangeAt(0)
n=i.range.endOffset}return n}}(jQuery,window,document),function(e,t,a){function i(){n=t[l](function(){r.each(function(){var t=e(this),a=t.width(),i=t.height(),n=e.data(this,o)
if(a!==n.w||i!==n.h)t.trigger(p,[n.w=a,n.h=i])}),i()},s[d])}var n,r=e([]),s=e.resize=e.extend(e.resize,{}),l="setTimeout",p="resize",o=p+"-special-event",d="delay",m="throttleWindow"
s[d]=250,s[m]=!0,e.event.special[p]={setup:function(){if(!s[m]&&this[l])return!1
var t=e(this)
if(r=r.add(t),e.data(this,o,{w:t.width(),h:t.height()}),1===r.length)i()},teardown:function(){if(!s[m]&&this[l])return!1
var t=e(this)
if(r=r.not(t),t.removeData(o),!r.length)clearTimeout(n)},add:function(t){function i(t,i,r){var s=e(this),l=e.data(this,o)
l.w=i!==a?i:s.width(),l.h=r!==a?r:s.height(),n.apply(this,arguments)}if(!s[m]&&this[l])return!1
var n
if(e.isFunction(t))return n=t,i
else n=t.handler,t.handler=i}}}(jQuery,this),function(e,t,a,i){t.ZK_JSP={},ZK_JSP.ParamData=[],ZK_JSP.PrivateData=[],ZK_JSP.PreviewData=[],ZK_JSP.TemplData={name:null,params:null,preview:null,"private":null},ZK_JSP.TemplsData=[{name:"新增","private":[{width:20,height:20,top:0,left:0,alias:"",type:"bgimage",align:"flex-start",text:""}],preview:['<div class="bgimage drsElement drsMoveHandle"></div>'],params:[{name:"模板名",value:""},{name:"类型",type:"combo",value:""},{name:"名称",type:"combo",value:"",lists:""},{name:"分辨率",type:"combo",value:"",lists:""},{name:"份数",type:"spin",value:"1"},{name:"彩色",type:"combo",value:"否"},{name:"方向",type:"combo",value:"纵向"},{name:"最大",value:""},{name:"最小",value:""},{name:"纸张",type:"combo",value:"x:210|y:105",lists:""},{name:"不可用",type:"input",value:"t:4.3|b:4.3|l:4.3|r:4.3"},{name:"字体",type:"combo",value:"",lists:""},{name:"字号",type:"spin",value:"12"}]}],ZK_JSP.PrinterList="",ZK_JSP.PrinterInfo=[],ZK_JSP.httpPrefix="http://localhost:9527/",ZK_JSP.textPrefix="JsPrintSrv",function(){var t=ZK_JSP.Http=function(){var e=this
e.httpPrefix="http://localhost:9527/"}
t.prototype={AjaxGetHandle:function(t,a,n){var r,s,l=this
if(a==i||null==a)s={}
else s=a
r=l.httpPrefix+t,e.ajax({url:r,timeout:1e4,dataType:"json",data:s,type:"get",success:function(t){if("function"==typeof n)t=e.extend(t,{status:200}),n(t)},error:function(e){if("function"==typeof n)n(e)}})},AjaxPostHandle:function(t,a,i){var n,r=this
n=r.httpPrefix+t,e.ajax({url:n,timeout:1e4,contentType:"multipart/form-data",processData:!1,dataType:"json",data:a,traditional:!0,type:"post",success:function(t){if("function"==typeof i)t=e.extend(t,{status:200}),i(t)},error:function(e){if("function"==typeof i)i(e)}})}}}(),function(){var a=ZK_JSP.Form=function(e){var t=this
if(t.formContainer=e,null==e)t.formContainer="body"}
a.prototype={create:function(t,a,i){var n=this
if(!e(n.contentWrapper).length)n._setupWindow(),n._setTitle(t),n._setSize(a,i),n._insertListener()},setupBtns:function(t,a,n,r){var s=this,l=!1
if(htmlTextBtn='<div class="ZK-winbtn"></div>',r==i)r=!0
if(s.callback=a,s.handler=n,t!=i){if("string"==typeof t&&""!=t)return
else if("object"==typeof t&&0==t.length)return
if(r)e(s.formContainer+" .ZK-winframe .ZK-winbtn").remove()
if(0==e(s.formContainer+" .ZK-winframe .ZK-winbtn").length)e(s.formContainer+" .ZK-winframe").append(htmlTextBtn)
else l=!0
if("string"==typeof t&&""!=t)if(htmlText='<div class="btn"><span>'+t+"</span></div>",l)e(s.formContainer+" .ZK-winframe .ZK-winbtn").prepend(htmlText)
else e(s.formContainer+" .ZK-winframe .ZK-winbtn").append(htmlText)
else if("object"==typeof t)t.forEach(function(t,a){if(""==t)return!1
if(!s._isBtnExisted(t))if(htmlText='<div class="btn"><span>'+t+"</span></div>",l)e(s.formContainer+" .ZK-winframe .ZK-winbtn").prepend(htmlText)
else e(s.formContainer+" .ZK-winframe .ZK-winbtn").append(htmlText)})}},setBtnDisable:function(t,a){var n,r,s,l=this
if(a==i)a=!0
n=e(l.formContainer+" .ZK-winframe .ZK-winbtn .btn"),n.each(function(i,n){if(r=e(n).find("span")[0],s=e(r).text(),s==t)if(a)e(n).addClass("disable")
else e(n).removeClass("disable")})},show:function(){var t=this
e(t.formContainer+" .ZK-winframe").css("visibility","visible")},hide:function(){var t=this
e(t.formContainer+" .ZK-winframe").css("visibility","hidden")},close:function(){var t=this
e(t.formContainer+" .ZK-winframe").remove()},getContentWarpper:function(){var e=this
return e.contentWrapper},showBusyMask:function(t,a,n,r){var s,l='<div class="ZK-mask" contenteditable="true"><div class="ZK-popup"><div class="popupcontent"><div class="imageloading"></div><div class="text"></div></div></div></div>'
if(r==i)r=0
if(s=t,null==s)s="body"
if(a==i||""==a)e(s+" .ZK-mask").remove()
else{if(e(s+" div.ZK-mask").length)e(s+" .ZK-mask").remove()
e(s).append(l),e(s+" .ZK-mask .text").text(a)}switch(n){case"warning":e(s+" .ZK-mask .imageloading").removeClass("imageloading").addClass("imagewarning")
break
case"error":e(s+" .ZK-mask .imageloading").removeClass("imageloading").addClass("imageerror")}if(0!=r)setTimeout(function(){e(s+" .ZK-mask").remove()},r)
else e(s+" .ZK-mask").focus(),e(s+" .ZK-mask").on("click keyup",function(t){t.stopPropagation(),t.preventDefault(),e(s+" .ZK-mask").remove()})},_setupWindow:function(t){var a=this,i='<div id="JsPrintSrvWin" class="ZK-winframe"><div class="ZK-wintitle"><div class="title">JsPrintSrv</div><div class="closebtn"></div></div><div class="ZK-contentwrapper"></div></div>'
e(a.formContainer).append(i),a.contentWrapper=a.formContainer+" .ZK-contentwrapper"},_setSize:function(a,i){var n=this,r=e(t).width(),s=e(t).height()
if(!(0>a||0>i||a>100||i>100)){if(null==a)n.formWidth=.8*r
else n.formWidth=r*a/100
if(e(n.formContainer+" .ZK-winframe").width(n.formWidth),null==i)n.formHeight=.8*s
else n.formHeight=s*i/100
e(n.formContainer+" .ZK-winframe").height(n.formHeight)}},_setTitle:function(t){var a=this
a.formTitle=ZK_JSP.textPrefix+" "+t,e(a.formContainer+" .ZK-wintitle .title").text(a.formTitle)},_insertListener:function(){var t=this
e(t.formContainer+" .ZK-wintitle").on("click","div.closebtn",function(){t.close()}),e(t.formContainer+" .ZK-winframe").on("mouseenter","div.btn",function(){if(!e(this).hasClass("disable"))e(this).addClass("hover")}).on("mouseleave","div.btn",function(){e(this).removeClass("hover")}),e(t.formContainer+" .ZK-winframe").on("click","div.btn",function(){if("function"==typeof t.callback&&!e(this).hasClass("disable"))t.callback(t.handler,e(this).text())})},_isBtnExisted:function(t){var a=this,i=!1,n=e(a.formContainer+" .ZK-winframe .ZK-winbtn").children()
if(0==n.length)return!1
else return e(n).each(function(a,n){if(e(n).text()==t)i=!0}),i}}}(),function(){var a=ZK_JSP.Templ=function(a,n,r){var s=this,l='<div class="templpreview"></div>'
if(r==i)r=!1
if(s.selectedEle=null,s.templType="票证",s.templWrapper=a,s.paperSize=n,e(s.templWrapper).append(l),r)s.setupMenu()
s.setContentArea(),s.sizeResolution={x:t.screen.width,y:t.screen.height},s.sizePaperframe={x:e(s.templWrapper+" .paperframe").width(),y:e(s.templWrapper+" .paperframe").height()},s.sizeValidArea={x:e(s.templWrapper+" .paperframe .validarea").width(),y:e(s.templWrapper+" .paperframe .validarea").height()},s.setPaperSize(s.paperSize),e(s.templWrapper+" .left").css("width","auto"),s._insertListener(),s._setBgImageUserData()}
a.prototype={setTemplType:function(e){var t=this
switch(e){case"票证":t.templType=e,t.setMenuDisable("header"),t.setMenuDisable("repeat"),t.setMenuDisable("footer"),t._resetPreviewArea()
break
case"普通":t.templType=e,t.setMenuDisable("header",!1),t.setMenuDisable("repeat",!1),t.setMenuDisable("footer",!1),t._resetPreviewArea()
break
case"条形码":t.templType=e,t.setMenuDisable("header"),t.setMenuDisable("repeat",!1),t.setMenuDisable("footer"),t._resetPreviewArea()
break
case"报表":t.templType=e,t.setMenuDisable("header",!1),t.setMenuDisable("repeat",!1),t.setMenuDisable("footer",!1),t._resetPreviewArea()}},setContentArea:function(){var t=this,a='<div class="contentarea"><div class="left"><div class="paperframe"><div class="validarea" contenteditable="true" tabindex="0"><div class="bgimage drsElement drsMoveHandle"></div></div></div><div class="measures">'+t.paperSize.x+'mm</div></div><div class="right"><div class="measures"><span>'+t.paperSize.y+'mm</span></div><div class="padding"></div></div><div class="append"></div></div>'
e(t.templWrapper+" .templpreview").append(a),t._dragResizeInit()},_setBgImageUserData:function(){var t,a=this,i={width:20,height:20,top:0,left:0,alias:"",type:"bgimage",align:"flex-start",text:""}
t=e(a.templWrapper+" .templpreview .paperframe .bgimage"),i.width=a._convertSize2MM(t.width()),i.height=a._convertSize2MM(t.height()),t.data("c",i)},setupMenu:function(){var t=this,a='<div class="menu"><div class="menugroup"><div class="menuitem"><image class="bgimage"/><input id="bgImage" class="filedialog" type="file" accept="image/gif,image/jpeg,image/png,image/jpg"/></div><div class="menuitem"><image class="bgremove disable"/></div></div><div class="menugroup"><div class="menuitem"><image class="text"/></div><div class="menuitem"><image class="alignleft disable"/></div><div class="menuitem"><image class="alignmiddle disable"/></div><div class="menuitem"><image class="alignright disable"/></div></div><div class="menugroup"><div class="menuitem"><image class="rect"/></div><div class="menuitem"><image class="ellipse"/></div><div class="menuitem"><image class="line"/></div><div class="menuitem"><image class="image"/><input id="image" class="filedialog" type="file" accept="image/gif,image/jpeg,image/png,image/jpg"/></div></div><div class="menugroup"><div class="menuitem"><image class="barcode"/></div><div class="menuitem"><image class="qrcode"/></div></div><div class="menugroup"><div class="menuitem"><image class="header disable"/></div><div class="menuitem"><image class="repeat disable"/></div><div class="menuitem"><image class="footer disable"/></div></div><div class="menugroup"><div class="menuitem"><image class="delete disable"/></div></div></div><div class="menu"><div class="menugroup">宽<div id="elementWidth" tabindex="0" class="keypress1 menuinput" contenteditable="false">0</div></div><div class="menugroup">高<div id="elementHeight" class="keypress1 menuinput" tabindex="1" contenteditable="false">0</div></div><div class="menugroup">上<div id="elementTop" class="keypress1 menuinput" tabindex="2" contenteditable="false">0</div></div><div class="menugroup">左<div id="elementLeft" class="keypress1 menuinput" tabindex="3" contenteditable="false">0</div></div><div class="menugroup">别名<div id="elementAlias" class="keypress2 menuinput menualias" tabindex="4" contenteditable="false"></div></div><div class="menugroup">内容<div id="elementText" class="keypress2 menuinput menutext" tabindex="5" contenteditable="false"></div></div><div class="menugroup">字号<div id="elementFontSize" class="keypress2 menuinput menufontsize" tabindex="6" contenteditable="false"></div></div></div>'
e(t.templWrapper+" .templpreview").append(a)},setMenuDisable:function(t,a){var n
if(a==i)a=!0
if(n=e(".ZK-contentwrapper .menu .menuitem"),n.length)n.each(function(i,n){if(itemClass=e(n).find("img").attr("class"),-1!=itemClass.indexOf(t)){if(a)itemClass=t+" disable"
else itemClass=t
return e(n).find("img").attr("class",itemClass),!1}})},setMenuEditStatus:function(t,a){var i=e(".ZK-contentwrapper .templpreview .menu .alignleft"),n=e(".ZK-contentwrapper .templpreview .menu .alignmiddle"),r=e(".ZK-contentwrapper .templpreview .menu .alignright"),s=e(".ZK-contentwrapper .templpreview .menu .delete")
if(a)i.removeClass("disable"),n.removeClass("disable"),r.removeClass("disable"),s.removeClass("disable")
else i.addClass("disable"),n.addClass("disable"),r.addClass("disable"),s.addClass("disable")},setUnvalidArea:function(e){var t,a,i=this,n={t:null,b:null,l:null,r:null}
if(a=!0,e=e.replace("：",":"),t=e.split("|"),4!=t.length)return!1
if(t.forEach(function(e,t){var i=e.split(":")
if(2!=i.length)a&=!1
n[i[0]]=i[1]}),a)i._setUnvalidArea(n.t,n.b,n.l,n.r)
return a},_resetPreviewArea:function(){var t=this,a=e(t.templWrapper+" .paperframe .validarea .bgimage").siblings()
a.remove()},setDefaultFont:function(e){var t=this
if("object"==typeof e){if(e.font!=i&&""!=e.font)t.defaultFont=e.font
if(e.fontsize!=i&&""!=e.fontsize)t.defaultFontSize=e.fontsize
t._reRenderAllText()}},_reRenderAllText:function(){var t,a,n,r=this,s=e(r.templWrapper+" .paperframe .validarea").children()
s.each(function(s,l){if(e(l).hasClass("text"))t=e(l).data("c"),a=t.font==i||""==t.font?r.defaultFont:t.font,n=t.fontsize==i||""==t.fontsize?r.defaultFontSize:t.fontsize,r._renderText(l,e(l).attr("id"),t.text,n,a)
else if(e(l).hasClass("repeat")){var p=e(r.templWrapper+" .paperframe .validarea .repeat").find("div.newelement")
p.each(function(t,a){if(e(a).hasClass("text"))r._renderElement(a)})}else if(e(l).hasClass("header")){var p=e(r.templWrapper+" .paperframe .validarea .header").find("div.newelement")
p.each(function(t,a){if(e(a).hasClass("text"))r._renderElement(a)})}else if(e(l).hasClass("footer")){var p=e(r.templWrapper+" .paperframe .validarea .footer").find("div.newelement")
p.each(function(t,a){if(e(a).hasClass("text"))r._renderElement(a)})}})},setPreviewContent:function(t){var a,n=this,r=e(n.templWrapper+" .paperframe .validarea")
r.children().remove(),r.append(t),n._setBgImageUserData(),a=r.children(),e.each(a,function(t,a){if(e(a).hasClass("bgimage"))if(""!=e(e(a).find("img")[0]).attr("src")&&e(e(a).find("img")[0]).attr("src")!=i)n.setMenuDisable("bgremove",!1)
if(e(a).hasClass("ellipse"))n._renderEllipse(a,e(a).attr("id"))
if(e(a).hasClass("line"))n._renderLine(a,e(a).attr("id"))
if(e(a).hasClass("repeat"))n.setMenuDisable("repeat")
if(e(a).hasClass("header"))n.setMenuDisable("header")
if(e(a).hasClass("footer"))n.setMenuDisable("footer")})},setPreviewPrivate:function(t){var a=this,n=e(a.templWrapper+" .paperframe .validarea").children()
n.each(function(n,r){if(typeof t[n]!=i){if(e(r).data("c",t[n]),"text"==t[n].type)a._renderText(r,e(r).attr("id"),t[n].text,t[n].fontsize,t[n].font)
if("image"==t[n].type)a._renderImage(r,e(r).attr("id"),t[n].text,t[n].name)
if("repeat"==t[n].type||"header"==t[n].type||"footer"==t[n].type){var s=e(a.templWrapper+" .paperframe .validarea ."+t[n].type).find("div.newelement"),l=t[n].repeatitems
s.each(function(t,n){if(typeof l[t]!=i)e(n).data("c",l[t]),a._renderElement(n)})}}})},getPreviewContent:function(){var t=this,a=e(t.templWrapper+" .paperframe .validarea"),i=[]
return a.find(".rect").children().remove(),a.find(".ellipse").children().remove(),a.find(".line").children().remove(),a.find(".text").children().remove(),a.find(".image").children().remove(),a.find(".dragresize").remove(),a.find(".drsElementSelected").removeClass("drsElementSelected"),a.children().each(function(t,a){i.push(e(a).prop("outerHTML"))}),i},getPreviewPrivate:function(){var t,a,i=this,n=e(i.templWrapper+" .paperframe .validarea").children(),r=[]
return n.each(function(i,n){if(a=e(n).data("c"),e(n).hasClass("repeat")||e(n).hasClass("header")||e(n).hasClass("footer"))t=e(n).find("div.newelement"),a.repeatitems=[],t.each(function(t,i){a.repeatitems.push(e(i).data("c"))})
r.push(a)}),r},_setUnvalidArea:function(t,a,i,n){var r,s=this,l=""
t*=s.cordFactor,l=t+"px ",n*=s.cordFactor,l+=n+"px ",a*=s.cordFactor,l+=a+"px ",i*=s.cordFactor,l+=i+"px ",r=e(s.templWrapper+" .left .validarea"),r.css("margin",l),l=parseInt(i)+parseInt(n),l="calc(100% - "+l+"px)",r.css("width",l),l=parseInt(t)+parseInt(a),l="calc(100% - "+l+"px)",r.css("height",l)},setPaperSize:function(t){var a=this
a.paperSize=t,width=a._convertSize2Pix(a.paperSize.x),e(a.templWrapper+" .left .paperframe").width(width),e(a.templWrapper+" .left .measures").width(width),e(a.templWrapper+" .left .measures").text(a.paperSize.x+"mm"),a._setPaperFrameHeight()},_setPaperFrameHeight:function(){var t,a=this
t=a._convertSize2Pix(a.paperSize.y),e(a.templWrapper+" .paperframe").height(t),e(a.templWrapper+" .right .measures").height(t),e(a.templWrapper+" .right .measures span").text(a.paperSize.y+"mm")},_convertSize2MM:function(e){var t=this,a=0
return t.cordFactor=t._getCordFactor(),a=(parseFloat(e)/t.cordFactor).toFixed(1)},_convertSize2Pix:function(e){var t=this,a=0
return t.cordFactor=t._getCordFactor(),a=(parseFloat(e)*t.cordFactor).toFixed(0)},_getCordFactor:function(){var e=this,t=0
if(parseInt(e.paperSize.x)<=210)t=parseFloat(e.sizePaperframe.x)/210
else t=parseFloat(e.sizePaperframe.x)/parseFloat(e.paperSize.x)
return t},_updateMenuInputValue:function(t){var a,n=e(".ZK-contentwrapper .templpreview .menu #elementWidth"),r=e(".ZK-contentwrapper .templpreview .menu #elementHeight"),s=e(".ZK-contentwrapper .templpreview .menu #elementTop"),l=e(".ZK-contentwrapper .templpreview .menu #elementLeft"),p=e(".ZK-contentwrapper .templpreview .menu #elementAlias"),o=e(".ZK-contentwrapper .templpreview .menu #elementText")
if($wrapperFontSize=e(".ZK-contentwrapper .templpreview .menu #elementFontSize"),a=e(t).data("c"),a!=i)if(n.text(a.width),r.text(a.height),s.text(a.top),l.text(a.left),p.text(a.alias),o.text(a.text),$wrapperFontSize.text(a.fontsize==i?"":a.fontsize),n.addClass("editable").attr("contenteditable","true"),r.addClass("editable").attr("contenteditable","true"),s.addClass("editable").attr("contenteditable","true"),l.addClass("editable").attr("contenteditable","true"),$wrapperFontSize.addClass("editable").attr("contenteditable","true"),!e(t).hasClass("bgimage"))p.addClass("editable").attr("contenteditable","true"),o.addClass("editable").attr("contenteditable","true")},_dragResizeInit:function(){var a=this,i=e(".ZK-contentwrapper .paperframe .validarea"),n=new DragResize("dragresize",{minWidth:1,minHeight:1,minLeft:0,minTop:0,maxLeft:i.width(),wrapper:a})
n.isElement=function(e){if(e.className&&e.className.indexOf("drsElement")>-1)return!0
else;},n.isHandle=function(e){if(e.className&&e.className.indexOf("drsMoveHandle")>-1)return!0
else;},n.ondragfocus=a._dragResizeFocus,n.ondragstart=function(e,t){},n.ondragmove=a._dragResizeMove,n.ondragend=a._dragResizeEnd,n.ondragblur=a._dragResizeBlur,n.apply(t)},_dragResizeFocus:function(t,a){var n,r=t
if(a!=i&&""!=a){if(n=e(a).data("c"),n.width=r._convertSize2MM(e(a).width()),n.height=r._convertSize2MM(e(a).height()),n.top=r._convertSize2MM(e(a).position().top),n.left=r._convertSize2MM(e(a).position().left),e(a).data("c",n),r._updateMenuInputValue(a),!e(a).hasClass("bgimage"))ZK_JSP.Templ.prototype.setMenuEditStatus(r,!0)
r.selectedEle=a,e(".ZK-contentwrapper .paperframe .validarea").focus()}},_dragResizeBlur:function(t,a){var i=this,n=e(".ZK-contentwrapper .templpreview .menu #elementWidth"),r=e(".ZK-contentwrapper .templpreview .menu #elementHeight"),s=e(".ZK-contentwrapper .templpreview .menu #elementTop"),l=e(".ZK-contentwrapper .templpreview .menu #elementLeft"),p=e(".ZK-contentwrapper .templpreview .menu #elementAlias"),o=e(".ZK-contentwrapper .templpreview .menu #elementText")
n.text(0),r.text(0),s.text(0),l.text(0),p.text(""),o.text(""),n.removeClass("editable").attr("contenteditable","false"),r.removeClass("editable").attr("contenteditable","false"),s.removeClass("editable").attr("contenteditable","false"),l.removeClass("editable").attr("contenteditable","false"),p.removeClass("editable").attr("contenteditable","false"),o.removeClass("editable").attr("contenteditable","false"),ZK_JSP.Templ.prototype.setMenuEditStatus(i,!1),i.selectedEle=null,e(".ZK-contentwrapper .paperframe .validarea").blur()},_dragResizeMove:function(t,a,i){var n=t
if(n._dragResizeFocus(t,i),e(i).hasClass("ellipse"))n._renderEllipse(i,e(i).attr("id"))
if(e(i).hasClass("line"))n._renderLine(i,e(i).attr("id"))
if(e(i).hasClass("text")){var r=e(i).data("c")
n._renderText(i,e(i).attr("id"),r.text,r.fontsize,r.font)}},_dragResizeEnd:function(t,a,i){var n=t
if(n._dragResizeFocus(t,i),!e(i).hasClass("header")&&!e(i).hasClass("repeat")&&!e(i).hasClass("footer"))n._repeatItemIdentify(t,i)},_repeatItemIdentify:function(t,a){var i,n,r,s,l,p,o,d,m,c,f=t
if(i=e(a).parent(),!i.hasClass("header")&&!i.hasClass("repeat")&&!i.hasClass("footer"))i=null
if(r={top:e(a).position().top,left:e(a).position().left,right:e(a).position().left+e(a).width(),bottom:e(a).position().top+e(a).height()},l=e(".ZK-contentwrapper .paperframe .validarea div.newelement.header"),l=l.length?l:null)p={top:l.position().top,left:l.position().left,right:l.position().left+l.width(),bottom:l.position().top+l.height()}
if(o=e(".ZK-contentwrapper .paperframe .validarea div.newelement.repeat"),o=o.length?o:null)d={top:o.position().top,left:o.position().left,right:o.position().left+o.width(),bottom:o.position().top+o.height()}
if(m=e(".ZK-contentwrapper .paperframe .validarea div.newelement.footer"),m=m.length?m:null)c={top:m.position().top,left:m.position().left,right:m.position().left+m.width(),bottom:m.position().top+m.height()}
if(!i&&l&&r.top>p.top&&r.left>p.left&&r.right<p.right&&r.bottom<p.bottom)s={top:r.top-p.top,left:r.left-p.left},f._moveElement(l,a,s)
else if(!i&&o&&r.top>d.top&&r.left>d.left&&r.right<d.right&&r.bottom<d.bottom)s={top:r.top-d.top,left:r.left-d.left},f._moveElement(o,a,s)
else if(!i&&m&&r.top>c.top&&r.left>c.left&&r.right<c.right&&r.bottom<c.bottom)s={top:r.top-c.top,left:r.left-c.left},f._moveElement(m,a,s)
else if(i)if(n={top:i.position().top,left:i.position().left,right:i.position().left+i.width(),bottom:i.position().top+i.height()},r.bottom>i.height()+e(a).height()/2||r.right<n.left-e(a).width()/2||r.left>n.right+e(a).width()/2)if(s={top:r.top+n.top,left:r.left+n.left,right:e(a).width()+r.left+n.left,bottom:e(a).height()+r.top+n.top},l&&s.top>p.top&&s.left>p.left&&s.right<p.right&&s.bottom<p.bottom)s={top:s.top-p.top,left:s.left-p.left},f._moveElement(l,a,s)
else if(o&&s.top>d.top&&s.left>d.left&&s.right<d.right&&s.bottom<d.bottom)s={top:s.top-d.top,left:s.left-d.left},f._moveElement(o,a,s)
else if(m&&s.top>c.top&&s.left>c.left&&s.right<c.right&&s.bottom<c.bottom)s={top:s.top-c.top,left:s.left-c.left},f._moveElement(m,a,s)
else f._moveElement(e(".ZK-contentwrapper .paperframe .validarea"),a,s)},_moveElement:function(t,a,i){var n,r,s,i,l=this
if(e(a).find(".dragresize").remove(),e(a).hasClass("drsElementSelected"))e(a).removeClass("drsElementSelected")
if(!e(a).hasClass("barcode")&&!e(a).hasClass("qrcode"))e(a).children().remove()
s=e(a).prop("outerHTML"),n=e(a).data("c"),e(a).remove(),t.append(s),r=t.find("div.newelement:last"),r.data("c",n),r.css("top",i.top),r.css("left",i.left),l._renderElement(r)},_loadBgImage:function(t){var a=this
if(ZK_JSP.Templ.prototype.setMenuDisable("bgremove",!1),typeof FileReader!=i)if(a.files.length){var n=a.files[0]
imgFileName=n.name,e(a).val("")
var r=new FileReader
r.readAsDataURL(n),r.onload=function(t){function a(){var t=e(".ZK-contentwrapper .left .validarea .bgimage"),a='<img id="ZK_BgImage"/>'
t.append(a),t=e(".ZK-contentwrapper .left .validarea .bgimage #ZK_BgImage"),i=s.width,r=s.height,t.attr("src",s.data),t.attr("alt",n.name),t.show()}var i,r,s=new Image
s.src=t.target.result,s.data=t.target.result,s.onload=a},t.target.value=""}},_loadImage:function(t){var a=this
if(typeof FileReader!=i)if(a.files.length){var n=a.files[0]
imgFileName=n.name,e(a).val("")
var r=new FileReader
r.readAsDataURL(n),r.onload=function(e){function t(){a=r.width,i=r.height,ZK_JSP.ViewSetup.templObj._addTemplElement("image",r.data,n.name)}var a,i,r=new Image
r.src=e.target.result,r.data=e.target.result,r.onload=t},t.target.value=""}},_getEleItemCount:function(){var t=this,a=e(t.templWrapper+" .paperframe .validarea"),i=0
return i=a.find("div.newelement").length},_addTemplElement:function(t,a,i){var n,r=this,s=e(r.templWrapper+" .paperframe .validarea")
switch(elementId="userElement",htmlText="",elementId+=r._getEleItemCount()+1,t){case"text":n={width:20,height:"auto",top:0,left:0,alias:"",type:"text",align:"flex-start",text:"文本",font:"",fontsize:""},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle text"><span></span></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r._renderText(e(r.templWrapper+" .paperframe .validarea #"+elementId),elementId,n.text,n.fontsize,n.font)
break
case"rect":n={width:40,height:20,top:0,left:0,type:"rect"},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle rect"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n)
break
case"ellipse":n={width:40,height:20,top:0,left:0,type:"ellipse"},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle ellipse"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r._renderEllipse(e(r.templWrapper+" .paperframe .validarea #"+elementId),elementId)
break
case"line":n={width:40,height:20,top:0,left:0,type:"line"},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle line"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r._renderLine(e(r.templWrapper+" .paperframe .validarea #"+elementId),elementId)
break
case"image":n={width:40,height:40,top:0,left:0,type:"image",text:a,name:i},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle image"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r._renderImage(e(r.templWrapper+" .paperframe .validarea #"+elementId),elementId,a,i)
break
case"barcode":n={width:40,height:20,top:0,left:0,type:"barcode",alias:"",text:""},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle barcode"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r._renderBarcode(e(r.templWrapper+" .paperframe .validarea #"+elementId),elementId)
break
case"qrcode":n={width:40,height:40,top:0,left:0,type:"qrcode",alias:"",text:""},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle qrcode"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r._renderQrcode(e(r.templWrapper+" .paperframe .validarea #"+elementId),elementId)
break
case"header":n={width:r.paperSize.x,height:r.paperSize.y/10,top:r.paperSize.y/4-r.paperSize.y/10-1,left:0,type:"header",repeatitems:[]},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle header"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r.setMenuDisable("header")
break
case"repeat":n={width:r.paperSize.x,height:r.paperSize.y/2,top:r.paperSize.y/4,left:0,type:"repeat",repeatitems:[]},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle repeat"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r.setMenuDisable("repeat")
break
case"footer":n={width:r.paperSize.x,height:r.paperSize.y/10,top:3*r.paperSize.y/4+1,left:0,type:"footer",repeatitems:[]},htmlText="<div id="+elementId+' class="newelement drsElement drsMoveHandle footer"></div>',s.append(htmlText),r._setTemplEleStyle(e(r.templWrapper+" .paperframe .validarea #"+elementId),n),r.setMenuDisable("footer")}e(r.selectedEle).find(".dragresize").css("visibility","hidden"),r._dragResizeBlur(r,r.selectedEle),r.selectedEle=e(r.templWrapper+" .paperframe .validarea #"+elementId)},_renderElement:function(t){var a,i=this
switch(a=e(t).data("c"),a.type){case"text":i._renderText(t,e(t).attr("id"),a.text,a.fontsize,a.font)
break
case"rect":break
case"ellipse":i._renderEllipse(t,e(t).attr("id"))
break
case"line":i._renderLine(t,e(t).attr("id"))
break
case"image":i._renderImage(t,e(t).attr("id"),a.text,a.name)}},_renderEllipse:function(t,a){var i,n,r,s=e(t).width(),l=e(t).height(),p="#cvs"+a,o='<canvas width="'+s+'" height="'+l+'" id="cvs'+a+'"></canvas>'
if(e(t).find("canvas").remove(),e(t).append(o),i=e(p)[0],n=i.getContext("2d"),s>=l)n.scale(1,l/s),r=s/2
else n.scale(s/l,1)
n.beginPath(),n.arc(r,r,r-1,0,2*Math.PI),n.stroke()},_renderLine:function(t,a){var i,n,r=e(t).width(),s=e(t).height(),l="#cvs"+a,p='<canvas width="'+r+'" height="'+s+'" id="cvs'+a+'"></canvas>'
e(t).find("canvas").remove(),e(t).append(p),i=e(l)[0],n=i.getContext("2d"),n.beginPath(),n.moveTo(0,0),n.lineTo(r,s),n.stroke()},_renderText:function(t,a,n,r,s){var l,p,o,d=this,m=e(t).width(),c=e(t).height(),f=0,u=0,v="#cvs"+a
if(e(t).find("canvas").remove(),o='<canvas width="'+m+'" height="'+c+'" id="cvs'+a+'"></canvas>',e(t).append(o),l=e(v)[0],p=l.getContext("2d"),s==i||""==s)s=d.defaultFont
if(r==i||""==r)r=d.defaultFontSize
r=d._getScalingFontSize(r),u=r,p.font=r+"px "+s,p.textAlign="left",p.textBaseline="bottom",f=p.measureText(n).width,f=f>m?m:f,u=r>c?c:r,e(v).attr("width",f),e(v).attr("height",u),p.font=r+"px "+s,p.textAlign="left",p.textBaseline="bottom",p.fillText(n,0,r)},_renderImage:function(t,a,i,n){var r,s='<img id="'+a+'"/>'
e(t).find("image").remove(),e(t).append(s),r=e(".ZK-contentwrapper .left .validarea .image #"+a),r.attr("src",i),r.attr("alt",n)},_renderBarcode:function(t,a){var i,n='<img id="'+a+'"/>'
e(t).find("image").remove(),e(t).append(n),i=e(".ZK-contentwrapper .left .validarea .barcode #"+a),i.attr("src","./source/barcode.jpg"),i.attr("alt","barcode.jpg")},_renderQrcode:function(t,a){var i,n='<img id="'+a+'"/>'
e(t).find("image").remove(),e(t).append(n),i=e(".ZK-contentwrapper .left .validarea .qrcode #"+a),i.attr("src","./source/qrcode.jpg"),i.attr("alt","qrcode.jpg")},_getScalingFontSize:function(e){var a=this
t.screen.height
return size=0,size=a._convertSize2Pix(e/72*25.4),size},_setTemplEleStyle:function(t,a){var i=this,n=0,r=0
if(t.data("c",a),"object"!=typeof a)return!1
for(key in a)switch(key){case"width":n=i._convertSize2Pix(a[key]),r=e(i.templWrapper+" .paperframe .validarea").width(),t.css(key,n>r?r:n)
break
case"height":n=i._convertSize2Pix(a[key]),r=e(i.templWrapper+" .paperframe .validarea").height(),t.css(key,n>r?r:n)
break
case"top":case"left":t.css(key,parseInt(i._convertSize2Pix(a[key]))+"px")
break
case"align":t.css("justify-content",a[key])
break
case"text":var s=t.find("span")[0]
e(s).text(a[key])
break
case"alias":}},_setMenuNextInputFocus:function(t){e(this).blur()
var a=e(this).parent().next().find("div.editable")
e(a).focus()},_updateSelectedElePosition:function(t,a){var i=this,n=e(t).data("c")
switch(a){case"left":n.left=parseFloat(n.left)-.1,n.left=n.left.toFixed(1),e(t).css("left",parseInt(i._convertSize2Pix(n.left)))
break
case"right":n.left=parseFloat(n.left)+.1,n.left=n.left.toFixed(1),e(t).css("left",parseInt(i._convertSize2Pix(n.left)))
break
case"up":n.top=parseFloat(n.top)-.1,n.top=n.top.toFixed(1),e(t).css("top",parseInt(i._convertSize2Pix(n.top)))
break
case"down":n.top=parseFloat(n.top)+.1,n.top=n.top.toFixed(1),e(t).css("top",parseInt(i._convertSize2Pix(n.top)))}e(t).data("c",n),i._updateMenuInputValue(t)},_insertListener:function(){var t=this
e(".ZK-contentwrapper .menu").on("mouseenter","div.menuitem",function(){if(!e(this).find("img").hasClass("disable"))e(this).addClass("hover")}).on("mouseleave","div.menuitem",function(){e(this).removeClass("hover")}),e(".ZK-contentwrapper .menu input#bgImage").get(0).onchange=t._loadBgImage,e(".ZK-contentwrapper .menu input#image").get(0).onchange=t._loadImage,e(".ZK-contentwrapper .menu").on("click","div.menuitem",function(){if(!e(this).find("img").hasClass("disable")){var a=e(this).find("img").attr("class"),i=a.split(" ")[0]
switch(i){case"bgimage":break
case"bgremove":e(".ZK-contentwrapper .left .validarea .bgimage #ZK_BgImage").remove(),t.setMenuDisable("bgremove",!0)
break
case"text":t._addTemplElement("text")
break
case"alignleft":if(t.selectedEle){var n=e(t.selectedEle).data("c")
n.align="flex-start",e(t.selectedEle).data("c",n),e(t.selectedEle).css("justify-content","flex-start")}break
case"alignmiddle":if(t.selectedEle){var n=e(t.selectedEle).data("c")
n.align="center",e(t.selectedEle).data("c",n),e(t.selectedEle).css("justify-content","center")}break
case"alignright":if(t.selectedEle){var n=e(t.selectedEle).data("c")
n.align="flex-end",e(t.selectedEle).data("c",n),e(t.selectedEle).css("justify-content","flex-end")}break
case"rect":case"ellipse":case"line":case"barcode":case"qrcode":case"header":case"repeat":case"footer":t._addTemplElement(i)
break
case"image":break
case"delete":if(t.selectedEle&&e(t.selectedEle).hasClass("repeat"))t.setMenuDisable("repeat",!1)
if(t.selectedEle&&!e(t.selectedEle).hasClass("bgimage"))t.selectedEle.remove(),t._dragResizeBlur(t,t.selectedEle)}}}),e(".ZK-contentwrapper .menu .menuinput").on("keydown",function(a){var a=a||event
if(t.menuInputValue=e(this).text(),parseInt(t.menuInputValue)>1&&"0"==t.menuInputValue.charAt(0))t.menuInputValue=t.menuInputValue.substr(1)}),e(".ZK-contentwrapper .menu .menuinput").on("keyup",function(a){var a=a||event,i=e(this).text(),n=i.lastIndexOf(".")
if(-1!=n&&i.length-n>2)e(this).text(t.menuInputValue)
if(parseInt(i)>1&&"0"==i.charAt(0))i=i.substr(1),e(this).text(i)
var r=e(t.selectedEle).data("c"),s=e(this).parent().text()
switch(s=s.replace(i,"")){case"宽":e(t.selectedEle).css("width",t._convertSize2Pix(i)),r.width=i
break
case"高":e(t.selectedEle).css("height",t._convertSize2Pix(i)),r.height=i
break
case"上":e(t.selectedEle).css("top",parseInt(t._convertSize2Pix(i))),r.top=i
break
case"左":e(t.selectedEle).css("left",parseInt(t._convertSize2Pix(i))),r.left=i
break
case"内容":var l=e(t.selectedEle).find("span")[0]
if(e(l).text(i),r.text=i,"text"==r.type)t._renderText(t.selectedEle,e(t.selectedEle).attr("id"),r.text,r.fontsize,r.font)
break
case"别名":r.alias=i
break
case"字号":t._renderText(t.selectedEle,e(t.selectedEle).attr("id"),r.text,i),r.fontsize=i}e(t.selectedEle).data("c",r)}),e(".ZK-contentwrapper .menu .keypress1").on("keypress",function(t){var t=t||event,a=e(this).text()
if(13==t.keyCode){e(this).blur()
var i=e(this).parent().next().find("div.editable")
if(0==i.length)i=e(this).parent().siblings().first().find("div.editable")
return e(i).focus(),void t.preventDefault()}if(!(t.keyCode>=48&&t.keyCode<=57||46==t.keyCode&&a.split(".").length<=1))return void t.preventDefault()
else;}),e(".ZK-contentwrapper .menu .keypress2").on("keypress",function(t){var t=t||event
e(this).text()
if(13==t.keyCode){e(this).blur()
var a=e(this).parent().next().find("div.editable")
if(0==a.length)a=e(this).parent().siblings().first().find("div.editable")
return e(a).focus(),void t.preventDefault()}}),e(".ZK-contentwrapper .paperframe .validarea").on("keydown",function(e){e.preventDefault()}),e(".ZK-contentwrapper .paperframe .validarea").on("keyup",function(e){if(t.selectedEle)switch(e.keyCode){case 37:t._updateSelectedElePosition(t.selectedEle,"left")
break
case 39:t._updateSelectedElePosition(t.selectedEle,"right")
break
case 38:t._updateSelectedElePosition(t.selectedEle,"up")
break
case 40:t._updateSelectedElePosition(t.selectedEle,"down")}})}}}()
var n=ZK_JSP.ViewSetup={tabIndex:null,templObj:null,currentItemValue:"",viewSetupContainer:null,viewSetupPrinterList:null,viewSetupPrinterParms:null,init:function(t){var a=this
if(a.tabIndex=0,a.viewSetupContainer=t,!e(a.viewSetupContainer).children().length)a._setupWindow(),a._initPrinterParmsWindow(),a._initPrinterComboList(),a._insertListener()},updateTemplNameList:function(t){var a,n=this,r="",s=""
if(a=n._getTemplNameList(),0!=e(n.viewSetupPrinterList).children().length)s=n._getSelectedTemplName(),e(n.viewSetupPrinterList).children().remove()
if("object"==typeof a)a.forEach(function(t,a){r='<div class="printeritem"><span>'+t+"</span></div>",e(n.viewSetupPrinterList).append(r)})
n._setTemplItemSelected(t==i?s:t)},_getTemplNameList:function(){var e=[]
return ZK_JSP.TemplsData.forEach(function(t,a){e.unshift(t.name)}),e},getTemplContent:function(){var e=this
return ZK_JSP.PreviewData=e.templObj.getPreviewContent(),ZK_JSP.PrivateData=e.templObj.getPreviewPrivate(),ZK_JSP.ParamData=e._getParamContent(),ZK_JSP.TemplData.name=e._filterTemplName(ZK_JSP.ParamData),ZK_JSP.TemplData.preview=ZK_JSP.PreviewData.concat(),ZK_JSP.TemplData["private"]=ZK_JSP.PrivateData.concat(),ZK_JSP.TemplData.params=ZK_JSP.ParamData.concat(),ZK_JSP.TemplData},_filterTemplName:function(e){if("object"==typeof e)return e.forEach(function(e,t){if("模板名"==e.name)return tempName=e.value,!1
else;}),tempName},_getParamContent:function(){var t=this,a=[]
return $paramswrapper=e(".ZK-contentwrapper .printerparms .paramblock .paramitem .itemvalue"),$paramswrapper.each(function(i,n){itemName=t._getCurrentInputName(n),itemValue=e(n).text(),itemData=e(n).parent().attr("data"),a.push({name:itemName,value:itemValue})}),a},_setTemplItemSelected:function(t){var a,n=this
if(a=e(n.viewSetupPrinterList+" .printeritem"),t==i||""==t)a.first().addClass("selected"),t=a.first().text()
a.each(function(i,r){if(t==e(r).text())return e(a[i]).addClass("selected"),n._loadTemplContent(t),!1
else;})},_getSelectedTemplName:function(){var t,a,i=this
return a=e(i.viewSetupPrinterList+" .printeritem"),a.each(function(a,i){if(e(i).hasClass("selected"))return t=e(e(this).find("span")[0]).text(),!1
else;}),t},_loadTemplContent:function(e){var t=this
ZK_JSP.TemplsData.forEach(function(a,i){if(a.name==e)return t._updateParamValue(a.params),t.templObj.setPreviewContent(a.preview),t.templObj.setPreviewPrivate(a["private"]),!1
else;})},_setupWindow:function(){var t=this,a='<div class="setview"><div class="printerlist"><div class="listwrapper"></div></div><div class="printerparms"><div class="paramswrapper"></div></div><div class="combopopup"></div><div class="combomask"></div></div>'
e(t.viewSetupContainer).append(a),t.viewSetupPrinterList=t.viewSetupContainer+" .printerlist .listwrapper",t.viewSetupPrinterParms=t.viewSetupContainer+" .printerparms .paramswrapper"},_updateParamValue:function(t){var a,n,r=this
n=e(".ZK-contentwrapper .printerparms .paramblock .paramitem .itemvalue"),n.each(function(n,s){if(a=r._getCurrentInputName(s),itemValue=r._getTemplParamValue(a,t),e(s).text(itemValue.value),""!=itemValue.lists||itemValue.lists!=i)$paramItemWrapper=e(s).parent(),$paramItemWrapper.attr("data",itemValue.lists)
switch(a){case"纸张":var l=r._parseSizeString("xy",itemValue.value)
if(0!=l)r.templObj.setPaperSize(l)
break
case"不可用":case"边距":var l=r._parseSizeString("tblr",itemValue.value)
if(0!=l)r.templObj.setUnvalidArea(itemValue.value)
break
case"字体":var p={}
p.font=itemValue.value,r.templObj.setDefaultFont(p)
break
case"字号":var p={}
p.fontsize=itemValue.value,r.templObj.setDefaultFont(p)}})},_getTemplParamValue:function(e,t){var a,i={name:"",type:"",value:"",lists:"",editable:!1}
if(a=e,"object"!=typeof t)return""
else return t.forEach(function(e,t){if(e.name==a)return i=e,!1
else;}),i},_initPrinterParmsWindow:function(e){var t=this,a=[{name:"模板名",type:"input",value:"",editable:!0},{name:"类型",type:"combo",value:"",lists:"票证,条形码,报表,普通",editable:!1}]
t._setParmBlock("模板",a),a=[{name:"名称",type:"combo",value:"",lists:"",editable:!1},{name:"分辨率",type:"combo",value:"",lists:"",editable:!1},{name:"份数",type:"spin",value:"1",editable:!0},{name:"彩色",type:"combo",value:"否",lists:"否,是",editable:!1},{name:"方向",type:"combo",value:"纵向",lists:"横向,纵向",editable:!1}],t._setParmBlock("打印机",a),a=[{name:"最大",type:"input",value:"",editable:!1},{name:"最小",type:"input",value:"",editable:!1},{name:"纸张",type:"combo",value:"x:210|y:105",lists:"",editable:!0},{name:"不可用",type:"input",value:"t:4.3|b:4.3|l:4.3|r:4.3",editable:!0}],t._setParmBlock("尺寸",a,"(mm）其中：x为宽度，y为高度；t为上边距，b为下边距，l为左边距，r为右边距"),a=[{name:"字体",type:"combo",value:"",lists:"",editable:!1},{name:"字号",type:"spin",value:"12",editable:!0}],t._setParmBlock("缺省样式",a),a=[],t._setPreivewBlock("模板维护",a)},_initPrinterComboList:function(){var e=this
e._setItemLists("名称",ZK_JSP.PrinterList)},_setPreivewBlock:function(t,a){var i=this,n='<div class="previewblock"><div class="blocktitle"></div><div id="ZK-TemplPreview" class="blockcontent"></div></div>'
e(i.viewSetupPrinterParms).append(n),i._setParmBlockTitle(t),i._initPreviewContent()},_initPreviewContent:function(){var e,t=this
e=t.viewSetupPrinterParms+" #ZK-TemplPreview",t.templObj=new ZK_JSP.Templ(e,{x:210,y:105},!0)},_setParmBlock:function(t,a,i){var n=this,r='<div class="paramblock"><div class="blocktitle"></div><div class="blockcontent"></div></div>'
if(e(n.viewSetupPrinterParms).append(r),n._setParmBlockTitle(t,i),"object"==typeof a)a.forEach(function(e,t){n._setParmBlockItem(e)})},_setParmBlockTitle:function(t,a){var i=this
if(e(i.viewSetupPrinterParms+" .blocktitle:last").text(t),a)e(i.viewSetupPrinterParms+" .blocktitle:last").append("<span>"+a+"</span>")
e(i.viewSetupPrinterParms+" .blocktitle:last").parent().attr("id",t)},_setParmBlockItem:function(t){var a=this,i=""
switch(t.type){case"combo":i='<div class="paramitem" type="combo"><div class="itemname">'+t.name+'</div><div class="itemvalue" contenteditable="true" tabindex="'+a.tabIndex+'">'+t.value+'</div><div class="combobtn"></div></div>',e(a.viewSetupPrinterParms+" .blockcontent:last").append(i),e(a.viewSetupPrinterParms+" .blockcontent:last .paramitem:last").attr("data",t.lists),e(a.viewSetupPrinterParms+" .blockcontent:last .paramitem:last").attr("id",t.name)
break
case"spin":i='<div class="paramitem" type="spin"><div class="itemname">'+t.name+'</div><div class="itemvalue" tabindex="'+a.tabIndex+'" contenteditable="true">'+t.value+'</div><div class="spinbtn"><div class="spinup"></div><div class="spindown"></div></div>',e(a.viewSetupPrinterParms+" .blockcontent:last").append(i),e(a.viewSetupPrinterParms+" .blockcontent:last .paramitem:last").attr("id",t.name)
break
case"input":default:i='<div class="paramitem" type="input"><div class="itemname">'+t.name+'</div><div class="itemvalue">'+t.value+"</div></div>",e(a.viewSetupPrinterParms+" .blockcontent:last").append(i),e(a.viewSetupPrinterParms+" .blockcontent:last .paramitem:last").attr("id",t.name)}if(t.editable)e(a.viewSetupPrinterParms+" .itemvalue:last").addClass("editable").attr("contenteditable","true")
a.tabIndex++},_focusToNextInput:function(t,a){var n,r,s,l,p=t,o=e(".combopopup")
if(a==i)a=!0
if(e(p).blur(),o.hide(),e(".combomask").hide(),n=e(".ZK-contentwrapper .printerparms .paramblock .paramitem .itemvalue[contenteditable='true']").parent(),s=e(e(p).parent().find(".itemname")[0]).text(),n.each(function(t,i){if(l=e(e(i).find(".itemname")[0]).text(),s==l){if(a)if(t==n.length-1)r=e(n[0]).find(".itemvalue")[0]
else r=e(n[t+1]).find(".itemvalue")[0]
else if(0==t)r=e(n[n.length-1]).find(".itemvalue")[0]
else r=e(n[t-1]).find(".itemvalue")[0]
return!1}}),!e(r).hasClass("editable")){var d=e(r).parent().attr("data"),m="#"+e(e(r).parentsUntil(".paramblock").parent()[0]).attr("id")+" #"+e(r).parent().attr("id")
e(r).focus(),ZK_JSP.ViewSetup._showComboBox(m,d)}else e(r).focus()},_setSelectedPopItem:function(t){var a=e(".combopopup"),i=a.find(".hover")
if(i.length>=1)e(t).text(e(i[0]).text())},_getCurrentInputName:function(t){return e(e(t).parent().find(".itemname")[0]).text()},_getRelativeItem:function(t,a,n){var r,s
if(n==i)n=!0
if(0==a.length)r=t[0]
else s=a.text(),t.each(function(a,i){if(itemName=e(i).text(),s==itemName){if(n)if(a==t.length-1)r=t[0]
else r=t[a+1]
else if(0==a)r=t[t.length-1]
else r=t[a-1]
return!1}})
return r},_parseSizeString:function(e,t){var a,i,n=e,r={}
if(i=!0,t=t.replace("：",":"),a=t.split("|"),a.length!=n.length)return!1
if(a.forEach(function(e,t){var a=e.split(":")
if(2!=a.length)return i&=!1,!0
if(-1==n.indexOf(a[0]))i&=!1
else r[a[0]]=a[1]}),i)return r
else return!1},_removePrinterItem:function(e){var t=this
ZK_JSP.TemplsData.forEach(function(a,i){if(a.name==e)return ZK_JSP.TemplsData.splice(i,1),t.updateTemplNameList(),!1
else;})},_insertListener:function(){var t=this
e(t.viewSetupPrinterList).on("click","div.printeritem",function(){e(this).siblings().removeClass("selected"),e(this).addClass("selected"),t._loadTemplContent(e(e(this).find("span")[0]).text())}),e(t.viewSetupPrinterList).on("click","div.hover",function(){var a=e(this).parent()
if(a.hasClass("selected")){var i=a.parent().find(".printeritem"),n=a.index(),r=e(i[n+1])
r.addClass("selected"),r.siblings().removeClass("selected"),t._loadTemplContent(r.text())}t._removePrinterItem(e(a.find("span")[0]).text()),a.remove()}),e(t.viewSetupPrinterList).on("mouseenter","div.printeritem",function(){if("新增"!=e(this).text()){var t='<div class="hover">删除</div>'
e(this).append(t)}}).on("mouseleave","div.printeritem",function(){e(t.viewSetupPrinterList+" .printeritem").find(".hover").remove()}),e(t.viewSetupPrinterParms).on("click","div.combobtn",function(){var a=e(this).parent().attr("data"),i="#"+e(e(this).parentsUntil(".paramblock").parent()[0]).attr("id")+" #"+e(this).parent().attr("id")
t._showComboBox(i,a)}),e(t.viewSetupPrinterParms).on("click","div.spinup",function(){var t=e(this).parent().parent().find(".itemvalue").text()
t=parseInt(t)+1,e(this).parent().parent().find(".itemvalue").text(t)}),e(t.viewSetupPrinterParms).on("click","div.spindown",function(){var t=e(this).parent().parent().find(".itemvalue").text()
if(t=parseInt(t)-1,0>=t)t=1
e(this).parent().parent().find(".itemvalue").text(t)}),e(".combopopup").on("click",".popupitem",function(t){var a=e(this).parent().attr("target")
e(a).text(e(this).text()),e(".combopopup").hide(),e(".combomask").hide()}),e(".combomask").on("click",function(t){e(".combopopup").hide(),e(this).hide()}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("keypress","div.itemvalue",function(a){var a=a||event
if("true"==e(this).attr("contenteditable")&&!e(this).hasClass("editable")&&13!=a.keyCode){var i=e(".combopopup")
return i.hide(),e(".combomask").hide(),void a.preventDefault()}if("true"==e(this).attr("contenteditable")&&!e(this).hasClass("editable")&&13==a.keyCode){var i=e(".combopopup")
t._setSelectedPopItem(this),i.hide(),e(".combomask").hide(),a.preventDefault()}if(13==a.keyCode){if(e(t.viewSetupContainer+" .ZK-mask").length)e(t.viewSetupContainer+" .ZK-mask").remove()
return t._focusToNextInput(this),void a.preventDefault()}}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("keyup","div:not(.editable)",function(a){var i,n,r,s=e(".ZK-contentwrapper .setview .combopopup")
switch(n=s.find(".hover"),i=s.children(),a.keyCode){case 40:r=t._getRelativeItem(i,n)
break
case 38:r=t._getRelativeItem(i,n,!1)}e(r).siblings().removeClass("hover"),e(r).addClass("hover")}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("keyup","div.itemvalue",function(a){var i=0
if(13!=a.keyCode&&e(t.viewSetupContainer+" .ZK-mask").length)e(t.viewSetupContainer+" .ZK-mask").remove()
switch(a.keyCode){case 37:if(!e(this).hasClass("editable"))t._setSelectedPopItem(this),t._focusToNextInput(this,!1)
else if(i=e(this).getCursorPosition(),0==i)t._focusToNextInput(this,!1)
break
case 39:if(!e(this).hasClass("editable"))t._setSelectedPopItem(this),t._focusToNextInput(this)
else if(i=e(this).getCursorPosition(),i==e(this).text().length)t._focusToNextInput(this)}}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("focus","div.itemvalue",function(a){t.currentItemValue=e(this).text()}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("input","div.editable",function(a){var i,n
switch(i=t._getCurrentInputName(this),n=e(this).text(),i){case"纸张":var r=t._parseSizeString("xy",n)
if(0!=r)t.templObj.setPaperSize(r)
break
case"不可用":case"边距":var r=t._parseSizeString("tblr",n)
if(0!=r)t.templObj.setUnvalidArea(n)
break
case"字体":t.templObj.setDefaultFont({font:n})
break
case"字号":t.templObj.setDefaultFont({fontsize:n})}}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("DOMNodeInserted","div:not(.editable)",function(a){var i,n
switch(i=t._getCurrentInputName(this),n=e(this).text(),i){case"名称":t._resetListContent(n)
break
case"类型":t.templObj.setTemplType(n)}}),e(".ZK-contentwrapper .printerparms .paramblock#缺省样式 .paramitem").on("DOMNodeInserted","div.itemvalue",function(a){var i,n
switch(i=t._getCurrentInputName(this),n=e(this).text(),i){case"字体":t.templObj.setDefaultFont({font:n})
break
case"字号":t.templObj.setDefaultFont({fontsize:n})}}),e(".ZK-contentwrapper .printerparms .paramblock .paramitem").on("blur","div.editable",function(a){var i,n
switch(i=t._getCurrentInputName(this),n=e(this).text(),i){case"纸张":if(0==t._parseSizeString("xy",n))e(this).text(t.currentItemValue),ZK_JSP.View.formObj.showBusyMask(".ZK-contentwrapper","输入内容格式错, e.g. x:210|y:297","warning")
break
case"不可用":case"边距":t._parseSizeString("tblr",n)
if(0==t._parseSizeString("tblr",n))e(this).text(t.currentItemValue),ZK_JSP.View.formObj.showBusyMask(".ZK-contentwrapper","输入内容格式错, e.g. t:4.3|b:4.3|l:4.3|r:4.3","warning")}})},_resetListContent:function(e){var t,a,i=this
ZK_JSP.PrinterInfo.forEach(function(n,r){if(n.printer==e)t=n.name,a=n.lists,i._setItemLists(t,a)})},_setItemLists:function(t,a){var i,n,r=e(".ZK-contentwrapper .printerparms .paramblock .paramitem")
r.each(function(r,s){if(i=e(s).find(".itemname").text(),n=e(s).attr("type"),i==t){if("combo"==n)if(e(s).attr("data",a),1==a.split(",").length)e(e(s).find(".itemvalue")[0]).text(a)
else e(e(s).find(".itemvalue")[0]).text("")
else e(e(s).find(".itemvalue")[0]).text(a)
return!1}})},_showComboBox:function(t,a,n,r){var s,l=this,p=e(".combopopup")
if(n==i)n=!0
if(r==i)r=!0
if(s=t+" .itemvalue",l._addComboItem(a),p.attr("target",s),r){var o=e(s).offset().left,d=e(s).width(),m=e(s).offset().top+e(s).height()+7,c=e(l.viewSetupContainer).height()-m+e(l.viewSetupContainer).offset().top
if(p.show().css({display:"block",width:d,"max-height":c}).offset({top:m,left:o}),n)e(".combomask").show().css("height",e(l.viewSetupContainer).height())}else p.hide(),e(".combomask").hide()},_addComboItem:function(t){var a,n=e(".combopopup")
if(n.children().remove(),""!=t&&t!=i)if(a=t.split(","),"object"==typeof a)a.forEach(function(e,t){item='<div class="popupitem">'+e+"</div>",n.append(item)})}}
ZK_JSP.View={httpObj:null,formObj:null,cbInit:!1,init:function(e){var t=this
t.httpObj=new ZK_JSP.Http,t.formObj=new ZK_JSP.Form(null),t.check(e)},check:function(e){var t=this
t.cbInit=e,t.httpObj.AjaxGetHandle("check",null,t.cbCheck)},cbCheck:function(e){var t=ZK_JSP.View
if(200!=e.status)t.isServiceReady=!1,console.log("JsPrintSrv is not ready")
else t.isServiceReady=!0,t._patchDeviceParams(e.data)
if("function"==typeof t.cbInit)t.cbInit(t.isServiceReady)
t.httpObj.AjaxGetHandle("setup/load",ZK_JSP.TemplsData,t.cbGotTempl)},_patchDeviceParams:function(e){var t,a,i,n=null,r=null,s=null
ZK_JSP.TemplsData.forEach(function(e,t){if("新增"==e.name)return n=e,!1
else;}),r=n.params,r.forEach(function(e,t){if("名称"==e.name)return s=e,!1
else;}),t=/\{(.+?)\}/gi,a=e.match(t)
for(var l=0;l<a.length;l++)if(i=JSON.parse(a[l]),"所有"==i.printer)s.lists=i.lists,ZK_JSP.PrinterList=i.lists
else ZK_JSP.PrinterInfo.push(i)},cbGotTempl:function(e){var t=ZK_JSP.View
if(200!=e.status)t.isServiceReady=!1
else if(e.errMsg==i)ZK_JSP.TemplsData.splice(1,ZK_JSP.TemplsData.length-1),e.forEach(function(e,t){ZK_JSP.TemplsData.push(e)})},setup:function(){var e=this
e.formObj.create("模板设置",null,null,null),memus=["确定","取消"],e.formObj.setupBtns(memus,e.cbMainFrame,e),n.init(e.formObj.getContentWarpper()),ZK_JSP.ViewSetup.updateTemplNameList(),e.formObj.show()},cbMainFrame:function(e,t){var a,i=e
if("确定"==t)if(a=n.getTemplContent(),""==a.name)return void i.formObj.showBusyMask(".ZK-contentwrapper","请输入模板名称","warning")
else newTemplName=i._updateTemplsData(a),i._uploadTemplsData(),n.updateTemplNameList(newTemplName)
else i.formObj.close()},_updateTemplsData:function(t){var a
if(isExisted=!1,ZK_JSP.TemplsData.forEach(function(e,i){if(e.name==t.name)return isExisted=!0,a=i,!1
else;}),isExisted)ZK_JSP.TemplsData.splice(a,1)
return ZK_JSP.TemplsData.push(e.extend({},t)),t.name},getTempls:function(){var e=[]
return ZK_JSP.TemplsData.forEach(function(t,a){if("新增"!=t.name)e.unshift(t.name)}),e},print:function(e,t){var a=this
if("function"==typeof t)a.httpObj.AjaxPostHandle("print",JSON.stringify(e),t)
else a.httpObj.AjaxPostHandle("print",JSON.stringify(e))},progress:function(e){var t=this
if("function"==typeof e)t.httpObj.AjaxPostHandle("progress",null,e)},_uploadTemplsData:function(){var e=this,t=ZK_JSP.TemplsData.concat()
for(index in t)if("新增"==t[index].name)t.splice(index,1)
var a=JSON.stringify(t)
e.httpObj.AjaxPostHandle("setup/save",a,e.cbUploadTempl),e.formObj.showBusyMask(".ZK-contentwrapper","正在处理","")},cbUploadTempl:function(e){if("success"==e.result)ZK_JSP.View.formObj.showBusyMask(".ZK-contentwrapper","","")
else ZK_JSP.View.formObj.showBusyMask(".ZK-contentwrapper",e.errMsg,"warning",2e3)}}}(jQuery,window,document)
